================================================================================
ナレトレ データ処理仕様書
================================================================================

本文書は、ナレトレアプリケーションにおけるデータ処理、API連携、バックエンド処理の
詳細仕様を定義します。UI仕様書と連携して使用してください。

================================================================================
目次
================================================================================

1. API エンドポイント一覧
2. ファイル処理
3. AI エージェント処理
4. リアルタイム音声会話処理
5. CSVデータ処理
6. 処理ID対応表

================================================================================
1. API エンドポイント一覧
================================================================================

--------------------------------------------------------------------------------
1.1 チャットAPI
--------------------------------------------------------------------------------

【処理ID: API-CHAT-001】
- エンドポイント: POST /api/chat
- 用途: 汎用チャット（GPT-4o）
- 使用箇所: PDF Vision解析、台本生成、プロンプト生成
- リクエスト:
  {
    "messages": [
      { "role": "user", "content": "..." },
      { "role": "assistant", "content": "..." }
    ]
  }
- レスポンス:
  {
    "content": "AIの応答テキスト"
  }
- 使用モデル: gpt-4o
- パラメータ: temperature=0.7
- 最大トークン: デフォルト

--------------------------------------------------------------------------------

【処理ID: API-CHAT-002】
- エンドポイント: POST /api/chat/roleplay
- 用途: ロープレ構築チャット（Claude）
- 使用箇所: チャットコンポーネント内のAI応答
- リクエスト:
  {
    "messages": [
      { "role": "user", "content": "..." },
      { "role": "assistant", "content": "..." }
    ]
  }
- レスポンス:
  {
    "content": "AIの応答テキスト"
  }
- 使用モデル: claude-3-5-sonnet-20241022
- 最大トークン: 4096
- システムプロンプト: prompts/roleplay-chat.txt


--------------------------------------------------------------------------------
1.2 ファイル解析API
--------------------------------------------------------------------------------

【処理ID: API-FILE-001】
- エンドポイント: POST /api/analyze-pdf
- 用途: PDFファイル解析
- 使用箇所: ファイルアップロード（PDF）
- リクエスト: multipart/form-data
  - file: PDFファイル
- レスポンス:
  {
    "content": "解析結果テキスト",
    "filename": "元のファイル名"
  }
- 処理詳細:
  - Base64エンコード → GPT-4o Vision APIで画像解析
  - 処理後に一時ファイル削除

--------------------------------------------------------------------------------

【処理ID: API-FILE-002】
- エンドポイント: POST /api/analyze-excel
- 用途: Excelファイル解析
- 使用箇所: ファイルアップロード（Excel）
- リクエスト: multipart/form-data
  - file: Excel (.xlsx/.xls) ファイル
- レスポンス:
  {
    "content": "解析結果テキスト",
    "filename": "元のファイル名"
  }

--------------------------------------------------------------------------------

【処理ID: API-FILE-003】
- エンドポイント: POST /api/analyze-word
- 用途: Wordファイル解析
- 使用箇所: ファイルアップロード（Word）
- リクエスト: multipart/form-data
  - file: Word (.docx/.doc) ファイル
- レスポンス:
  {
    "content": "解析結果テキスト",
    "filename": "元のファイル名"
  }


--------------------------------------------------------------------------------
1.3 音声処理API
--------------------------------------------------------------------------------

【処理ID: API-AUDIO-001】
- エンドポイント: POST /api/transcribe
- 用途: 音声文字起こし（Whisper）
- 使用箇所: 音声/動画ファイルアップロード
- リクエスト: multipart/form-data
  - audio: 音声ファイル (.mp3/.wav)
- レスポンス:
  {
    "text": "文字起こし結果"
  }
- 使用モデル: whisper-1
- 言語設定: 日本語 (ja)

--------------------------------------------------------------------------------

【処理ID: API-AUDIO-002】
- エンドポイント: POST /api/tts
- 用途: テキスト音声変換（TTS）
- 使用箇所: （現在未使用、将来拡張用）
- リクエスト:
  {
    "text": "読み上げるテキスト"
  }
- レスポンス: audio/mpeg (バイナリ)
- 使用モデル: tts-1
- 音声: alloy


--------------------------------------------------------------------------------
1.4 Realtime API
--------------------------------------------------------------------------------

【処理ID: API-REALTIME-001】
- エンドポイント: POST /api/realtime-session
- 用途: Realtime APIエフェメラルキー取得
- 使用箇所: ロープレセッション開始時
- リクエスト: なし（POST本文不要）
- レスポンス:
  {
    "url": "wss://api.openai.com/v1/realtime?model=...",
    "client_secret": "エフェメラルトークン"
  }
- 処理詳細:
  - OpenAI APIにPOSTしてセッショントークンを取得
  - モデル: gpt-4o-realtime-preview-2024-12-17
  - 音声: alloy

--------------------------------------------------------------------------------

【処理ID: API-REALTIME-002】
- エンドポイント: WebSocket /realtime
- 用途: OpenAI Realtime APIプロキシ
- 使用箇所: ロープレセッション中のリアルタイム音声会話
- 処理詳細:
  - クライアント ⇔ サーバー ⇔ OpenAI Realtime API
  - サーバーがプロキシとして中継
  - 音声データはPCM16形式、24kHz
  - VAD（Voice Activity Detection）によるターン検出


--------------------------------------------------------------------------------
1.5 エージェントAPI
--------------------------------------------------------------------------------

【処理ID: API-AGENT-001】
- エンドポイント: POST /api/agents
- 用途: AIエージェント処理の統一エンドポイント
- 使用箇所: ロープレ生成、フィードバック生成
- リクエスト:
  {
    "agent": "エージェント名",
    "context": { ... エージェント固有のコンテキスト ... }
  }
- レスポンス: エージェントごとに異なる（後述）


================================================================================
2. ファイル処理
================================================================================

--------------------------------------------------------------------------------
2.1 対応ファイル形式
--------------------------------------------------------------------------------

【処理ID: FILE-001】テキストファイル処理
- 対応拡張子: .txt
- 処理方式: FileReader.readAsText (UTF-8)
- 処理場所: クライアント側

--------------------------------------------------------------------------------

【処理ID: FILE-002】PDF処理
- 対応拡張子: .pdf
- 処理方式: pdf.js + GPT-4 Vision
- 処理フロー:
  1. pdf.js でPDFを読み込み
  2. 各ページをCanvas描画（scale: 2.0）
  3. Canvas → Base64 PNG
  4. GPT-4 Vision API で画像解析
  5. 全ページのテキストを結合
- 処理場所: クライアント側（画像化）+ サーバー側（Vision API）

--------------------------------------------------------------------------------

【処理ID: FILE-003】PowerPoint処理
- 対応拡張子: .ppt, .pptx
- 処理方式: JSZip でXML解析
- 処理フロー:
  1. JSZipでPPTXを展開
  2. ppt/slides/slide*.xml からテキスト抽出
  3. <a:t>タグの内容を取得
- 制限事項: テキストのみ抽出、図表・画像は非対応
- 推奨: PDF変換してアップロード
- 処理場所: クライアント側

--------------------------------------------------------------------------------

【処理ID: FILE-004】Excel処理
- 対応拡張子: .xls, .xlsx
- 処理方式: XLSX.js ライブラリ
- 処理フロー:
  1. XLSXでワークブック読み込み
  2. 各シートをCSV形式に変換
  3. シート名と共にテキスト化
- 処理場所: クライアント側

--------------------------------------------------------------------------------

【処理ID: FILE-005】音声処理
- 対応拡張子: .mp3, .wav
- 処理方式: OpenAI Whisper API
- 処理フロー:
  1. FormDataでファイルをサーバーに送信
  2. サーバーがWhisper APIを呼び出し
  3. 文字起こし結果を返却
- 処理場所: サーバー側

--------------------------------------------------------------------------------

【処理ID: FILE-006】動画処理
- 対応拡張子: .mp4, .mov
- 処理方式: FFmpeg WASM + Whisper API
- 処理フロー:
  1. FFmpeg WASMで動画から音声抽出
  2. MP3形式に変換
  3. Whisper APIで文字起こし
- ライブラリ: @ffmpeg/ffmpeg, @ffmpeg/core
- 処理場所: クライアント側（FFmpeg）+ サーバー側（Whisper）


--------------------------------------------------------------------------------
2.2 ファイルアップロード共通処理
--------------------------------------------------------------------------------

【処理ID: FILE-UPLOAD-001】
- ファイルサイズ制限: 10MB
- 一時ファイル保存先: uploads/
- 処理後の一時ファイル: 自動削除

【ファイルタイプ分類】
- 見本データ（sample）: 商談や接客の正解例
- 教材データ（material）: 学ばせたい内容の資料
- 自社データ（company）: 商品情報や会社概要
- 顧客データ（customer）: 想定顧客やペルソナ
- その他（other）: 上記以外


================================================================================
3. AI エージェント処理
================================================================================

--------------------------------------------------------------------------------
3.1 ロープレサポートエージェント
--------------------------------------------------------------------------------

【処理ID: AGENT-001】
- エージェント名: roleplay-support
- 用途: チャットでのロープレ設計支援
- 使用モデル: claude-3-5-sonnet-20241022
- プロンプトファイル: prompts/roleplay-support-agent.md
- 入力:
  {
    "userInput": "ユーザーの発言",
    "files": [{ "name": "...", "summary": "..." }],
    "currentDesign": { ロープレ設計データ }
  }
- 出力:
  {
    "response": "AIの応答メッセージ",
    "updatedDesign": { 更新されたロープレ設計 }
  }


--------------------------------------------------------------------------------
3.2 台本生成エージェント
--------------------------------------------------------------------------------

【処理ID: AGENT-002】台本モード用台本生成
- エージェント名: script-generation-subtitle
- 用途: 台本モード用の会話台本生成
- 使用モデル: claude-3-5-sonnet-20241022
- プロンプトファイル: prompts/script-generation-subtitle.md
- 入力:
  {
    "roleplayDesign": { ロープレ設計データ },
    "files": [{ "name": "...", "content": "..." }]
  }
- 出力:
  {
    "mode": "subtitle",
    "script": "生成された台本テキスト"
  }

--------------------------------------------------------------------------------

【処理ID: AGENT-003】ポイントモード用台本生成
- エージェント名: script-generation-points
- 用途: ポイントモード用の会話台本生成
- 使用モデル: claude-3-5-sonnet-20241022
- プロンプトファイル: prompts/script-generation-points.md
- 入力/出力: AGENT-002と同様

--------------------------------------------------------------------------------

【処理ID: AGENT-004】実戦モード用台本生成
- エージェント名: script-generation-practice
- 用途: 実戦モード用の会話台本生成
- 使用モデル: claude-3-5-sonnet-20241022
- プロンプトファイル: prompts/script-generation-practice.md
- 入力/出力: AGENT-002と同様


--------------------------------------------------------------------------------
3.3 システムプロンプト生成エージェント
--------------------------------------------------------------------------------

【処理ID: AGENT-005】台本モードプロンプト生成
- エージェント名: system-prompt-subtitle
- 用途: 台本モード用システムプロンプト生成
- 使用モデル: claude-3-5-sonnet-20241022
- プロンプトファイル: prompts/system-prompt-subtitle-mode.md
- 入力:
  {
    "roleplayDesign": { ロープレ設計データ },
    "script": "台本テキスト",
    "files": [{ "name": "...", "content": "..." }]
  }
- 出力:
  {
    "mode": "subtitle",
    "systemPrompt": "生成されたシステムプロンプト"
  }

--------------------------------------------------------------------------------

【処理ID: AGENT-006】お手本モードプロンプト生成
- エージェント名: system-prompt-aiDemo
- プロンプトファイル: prompts/system-prompt-aiDemo-mode.md
- 入力/出力: AGENT-005と同様

--------------------------------------------------------------------------------

【処理ID: AGENT-007】確認モードプロンプト生成
- エージェント名: system-prompt-confirmation
- プロンプトファイル: prompts/system-prompt-confirmation-mode.md
- 入力/出力: AGENT-005と同様

--------------------------------------------------------------------------------

【処理ID: AGENT-008】実戦モードプロンプト生成
- エージェント名: system-prompt-practice
- プロンプトファイル: prompts/system-prompt-practice-mode.md
- 入力/出力: AGENT-005と同様


--------------------------------------------------------------------------------
3.4 フィードバックエージェント
--------------------------------------------------------------------------------

【処理ID: AGENT-009】
- エージェント名: feedback
- 用途: ロープレ終了後のフィードバック生成
- 使用モデル: claude-3-5-sonnet-20241022
- プロンプトファイル: prompts/feedback-prompt.md
- 入力:
  {
    "roleplayDesign": { ロープレ設計データ },
    "conversationLog": "会話ログテキスト",
    "mode": "確認/実戦"
  }
- 出力（JSON形式）:
  {
    "totalScore": 85,
    "feedback": "フィードバックテキスト"
  }


--------------------------------------------------------------------------------
3.5 エージェントオーケストレーター
--------------------------------------------------------------------------------

【処理ID: AGENT-ORCH-001】ロープレ生成フロー
- 処理フロー:
  1. ロープレ設計データと選択ファイルを取得
  2. 3つの台本を並列生成（AGENT-002, 003, 004）
  3. 4つのシステムプロンプトを並列生成（AGENT-005, 006, 007, 008）
  4. 結果を返却
- 並列処理: Promise.all() を使用


================================================================================
4. リアルタイム音声会話処理
================================================================================

--------------------------------------------------------------------------------
4.1 セッション開始処理
--------------------------------------------------------------------------------

【処理ID: REALTIME-001】セッション開始
- トリガー: スタートボタンクリック
- 処理フロー:
  1. /api/realtime-session でエフェメラルキー取得
  2. WebSocket接続確立
     - URL: wss://api.openai.com/v1/realtime
     - プロトコル: ['realtime', 'openai-insecure-api-key.{token}', 'openai-beta.realtime-v1']
  3. session.created イベント受信
  4. session.update 送信（セッション設定）
  5. session.updated イベント受信
  6. マイク初期化

【セッション設定パラメータ】
{
  "modalities": ["audio", "text"],
  "instructions": "あなたは...",  // モード別システムプロンプト
  "voice": "alloy",
  "input_audio_format": "pcm16",
  "output_audio_format": "pcm16",
  "turn_detection": {
    "type": "server_vad",
    "threshold": 0.5,
    "prefix_padding_ms": 300,
    "silence_duration_ms": 500
  }
}


--------------------------------------------------------------------------------
4.2 音声入力処理
--------------------------------------------------------------------------------

【処理ID: REALTIME-002】マイク初期化
- AudioContext設定: sampleRate=24000
- マイク設定:
  - sampleRate: 24000
  - channelCount: 1
  - echoCancellation: true
  - noiseSuppression: true
- 音声処理: ScriptProcessorNode (bufferSize=2048)

【処理ID: REALTIME-003】音声データ送信
- 処理フロー:
  1. Float32配列を取得
  2. PCM16に変換
  3. Base64エンコード
  4. input_audio_buffer.append イベント送信
- 送信形式:
  {
    "type": "input_audio_buffer.append",
    "audio": "base64エンコードされたPCM16データ"
  }


--------------------------------------------------------------------------------
4.3 音声出力処理
--------------------------------------------------------------------------------

【処理ID: REALTIME-004】音声再生
- 受信イベント: response.audio.delta
- 処理フロー:
  1. Base64デコード
  2. PCM16 → Float32変換
  3. AudioBuffer作成（sampleRate=24000）
  4. AudioBufferSource で再生
- 音声キュー: 連続再生のためキュー管理


--------------------------------------------------------------------------------
4.4 Realtime APIイベント
--------------------------------------------------------------------------------

【受信イベント】
- session.created: セッション作成完了
- session.updated: セッション設定完了
- input_audio_buffer.speech_started: 発話検出開始
- response.created: AI応答生成開始
- response.audio.delta: 音声データチャンク
- response.done: AI応答完了
- error: エラー

【送信イベント】
- session.update: セッション設定
- input_audio_buffer.append: 音声データ追加
- input_audio_buffer.commit: 音声バッファ確定
- response.create: 応答生成リクエスト


--------------------------------------------------------------------------------
4.5 セッション終了処理
--------------------------------------------------------------------------------

【処理ID: REALTIME-005】セッション終了
- トリガー: 停止ボタンクリック
- 処理フロー:
  1. WebSocket切断
  2. AudioProcessor切断
  3. AudioContext停止
  4. MediaStream停止（トラック停止）
  5. UI状態リセット


================================================================================
5. CSVデータ処理
================================================================================

--------------------------------------------------------------------------------
5.1 CSV読み込み
--------------------------------------------------------------------------------

【処理ID: CSV-001】CSVパース
- 対応形式: カンマ区切り、UTF-8
- ヘッダー列:
  日付, Org, Account, Group, Player, カテゴリ, レベル, レッスン, スコア, 発話時間, プレイ時間
- パース処理:
  - バッチサイズ: 100行
  - 日付: Date型に変換
  - レベル・スコア: parseInt
  - 発話時間・プレイ時間: parseFloat
- 処理場所: クライアント側

--------------------------------------------------------------------------------

【処理ID: CSV-002】デモデータ読み込み
- ファイル: public/demo-data.csv
- 読み込み: fetch API
- 処理: CSV-001と同じパース処理


--------------------------------------------------------------------------------
5.2 データ構造
--------------------------------------------------------------------------------

【セッションデータ】
{
  date: Date,        // セッション日時
  org: string,       // 組織名
  account: string,   // アカウント名
  group: string,     // グループ名
  player: string,    // プレイヤー名
  category: string,  // カテゴリ
  level: number,     // レベル (1-5)
  lesson: string,    // レッスン名
  score: number,     // スコア (0-100)
  speechTime: number, // 発話時間（秒）
  playTime: number   // プレイ時間（秒）
}


--------------------------------------------------------------------------------
5.3 フィルタリング
--------------------------------------------------------------------------------

【処理ID: CSV-003】フィルター状態
{
  lessons: {},      // レッスン選択状態（階層式）
  players: {},      // プレイヤー選択状態（階層式）
  startMonth: null, // 期間開始月
  endMonth: null    // 期間終了月
}

【期間自動計算】
- 初期値計算:
  1. 全データから最新日付を取得
  2. 終了月 = 最新日付の月
  3. 開始月 = 最新日付の6ヶ月前


================================================================================
6. 処理ID対応表
================================================================================

以下は、UI仕様書内で参照される処理IDと本仕様書の対応表です。

--------------------------------------------------------------------------------
コンテンツ作成画面
--------------------------------------------------------------------------------

| UI操作                      | 処理ID                |
|----------------------------|----------------------|
| チャット送信               | API-CHAT-002         |
| ファイルアップロード（PDF） | FILE-002             |
| ファイルアップロード（PPT） | FILE-003             |
| ファイルアップロード（Excel）| FILE-004            |
| ファイルアップロード（音声）| FILE-005            |
| ファイルアップロード（動画）| FILE-006            |
| ロープレ生成               | AGENT-ORCH-001       |
| スタートボタン             | REALTIME-001         |
| 停止ボタン                 | REALTIME-005         |

--------------------------------------------------------------------------------
データ読み込み画面
--------------------------------------------------------------------------------

| UI操作                      | 処理ID                |
|----------------------------|----------------------|
| CSVファイル読み込み         | CSV-001              |
| デモデータ読み込み         | CSV-002              |

--------------------------------------------------------------------------------
サマリー画面
--------------------------------------------------------------------------------

| UI操作                      | 処理ID                |
|----------------------------|----------------------|
| フィルター適用             | CSV-003              |


================================================================================
付録: プロンプトファイル一覧
================================================================================

prompts/
├── roleplay-chat.txt               - ロープレ構築チャット用
├── roleplay-support-agent.md       - ロープレサポートエージェント用
├── script-generation-subtitle.md   - 台本モード台本生成用
├── script-generation-points.md     - ポイントモード台本生成用
├── script-generation-practice.md   - 実戦モード台本生成用
├── system-prompt-subtitle-mode.md  - 台本モードプロンプト生成用
├── system-prompt-aiDemo-mode.md    - お手本モードプロンプト生成用
├── system-prompt-confirmation-mode.md - 確認モードプロンプト生成用
├── system-prompt-practice-mode.md  - 実戦モードプロンプト生成用
├── feedback-prompt.md              - フィードバック生成用
├── README.md                       - プロンプトファイルの説明
├── chat/
│   ├── design-assistant.md         - 設計アシスタント用
│   └── file-upload-handler.md      - ファイルアップロード処理用
├── generation/
│   ├── script-subtitle.md          - 台本モード台本生成（別バージョン）
│   ├── script-points.md            - ポイントモード台本生成（別バージョン）
│   └── script-practice.md          - 実戦モード台本生成（別バージョン）
├── runtime/
│   ├── mode-subtitle.md            - 台本モード実行時用
│   ├── mode-demo.md                - お手本モード実行時用
│   ├── mode-confirmation.md        - 確認モード実行時用
│   └── mode-practice.md            - 実戦モード実行時用
└── evaluation/
    └── feedback.md                 - フィードバック評価用


================================================================================
付録: 外部ライブラリ一覧
================================================================================

【クライアント側】
- pdf.js: PDFパース・描画
- JSZip: PowerPoint (ZIP形式) 展開
- XLSX.js: Excel パース
- FFmpeg WASM (@ffmpeg/ffmpeg, @ffmpeg/core): 動画→音声変換
- Chart.js: グラフ描画

【サーバー側】
- express: Webフレームワーク
- ws: WebSocketサーバー
- multer: ファイルアップロード処理
- openai: OpenAI API クライアント
- @anthropic-ai/sdk: Claude API クライアント
- dotenv: 環境変数管理


================================================================================
付録: 環境変数
================================================================================

OPENAI_API_KEY    - OpenAI APIキー（必須）
ANTHROPIC_API_KEY - Anthropic APIキー（必須）
PORT              - サーバーポート（デフォルト: 3000）
